# Trigger on all branches
trigger:
- '*'

# Use latest Ubuntu image
pool:
  vmImage: 'ubuntu-latest'

# Pipeline Steps
steps:
- checkout: self

# Set Node.js Version to 20.x
- task: UseNode@1
  inputs:
    version: '20.x'

# Install Dependencies & Build
- script: |
    npm install
    npm run build
  displayName: 'Install Dependencies & Build'

# Sync to GitHub Repository
- script: |
    # Install urlencode function to encode reserved characters in passwords
    sudo apt-get install gridsite-clients

    # Create local mirror of Azure DevOps repository
    git clone --mirror https://${AZURE_GIT_USERNAME}:$(urlencode ${AZURE_GIT_PASSWORD})@${AZURE_REPO_URL} repo-mirror

    # Sync GitHub repository
    cd repo-mirror
    git push --mirror "https://${GITHUB_USERNAME}:$(urlencode ${GITHUB_TOKEN})@github.com/${GITHUB_USERNAME}/${GITHUB_REPO}.git"
  displayName: 'Sync repository with GitHub'
  env:
    AZURE_REPO_URL: $(AZURE_REPO_URL)
    AZURE_GIT_USERNAME: $(AZURE_GIT_USERNAME)
    AZURE_GIT_PASSWORD: $(AZURE_GIT_PASSWORD)
    GITHUB_USERNAME: $(GITHUB_USERNAME)
    GITHUB_TOKEN: $(GITHUB_TOKEN)
    GITHUB_REPO: $(GITHUB_REPO)
